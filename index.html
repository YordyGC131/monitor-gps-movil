#include <TinyGPS++.h>
#include <Preferences.h>
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

// --- UUIDs ESTÁNDAR UART (Nordic) ---
#define SERVICE_UUID           "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_RX "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_TX "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

// --- HARDWARE ---
static const int RXPin = 16; 
static const int TXPin = 17; 
static const int LED_TRIGGER = 2; 
static const uint32_t GPSBaud = 9600;

const double HDOP_MAXIMO = 5.0; 
const int polyPoints = 4;
double polyLat[polyPoints]; 
double polyLon[polyPoints]; 

TinyGPSPlus gps;
Preferences preferences; 

BLECharacteristic *pTxCharacteristic;
bool deviceConnected = false;
bool oldDeviceConnected = false;
bool modoConfig = false;
bool zonaCargada = false;

// --- CALLBACKS DE CONEXIÓN ---
class MyServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
      deviceConnected = true;
    };
    void onDisconnect(BLEServer* pServer) {
      deviceConnected = false;
    }
};

// --- CALLBACKS DE LECTURA (CORREGIDO PARA ESP32 v3.0+) ---
class MyCallbacks: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
      // CORRECCIÓN AQUÍ: Usamos String de Arduino directamente
      String rxValue = pCharacteristic->getValue(); 
      
      if (rxValue.length() > 0) {
        String cmd = rxValue; // Ya viene como String, no hace falta convertir
        cmd.trim();
        
        // Procesar Comandos
        if (cmd == "CONFIG") modoConfig = true;
        else if (cmd == "GEOJSON") sendGeoJSON();
        else if (cmd == "RESET") {
           preferences.begin("geocerca", false);
           preferences.clear();
           preferences.end();
           ESP.restart();
        }
        else if (modoConfig) {
           if(saveCoords(cmd)) {
             modoConfig = false;
             delay(500); ESP.restart();
           }
        }
      }
    }

    bool saveCoords(String d) {
        double tLat[4], tLon[4];
        int idx = 0, next = 0;
        for (int i = 0; i < 8; i++) {
          next = d.indexOf(',', idx);
          String s = (next == -1) ? d.substring(idx) : d.substring(idx, next);
          s.trim();
          double v = s.toDouble();
          if (v == 0.0 && s != "0") return false;
          if (i % 2 == 0) tLat[i/2] = v; else tLon[i/2] = v;
          if (next == -1 && i < 7) return false;
          idx = next + 1;
        }
        preferences.begin("geocerca", false);
        for(int i=0; i<4; i++) {
          preferences.putDouble(("la"+String(i)).c_str(), tLat[i]);
          preferences.putDouble(("lo"+String(i)).c_str(), tLon[i]);
        }
        preferences.putBool("init", true);
        preferences.end();
        return true;
    }

    void sendGeoJSON() {
        if(!zonaCargada) return;
        // BLE tiene limite de tamaño, enviamos en trozos
        String p1 = "GEOJSON:{\"type\":\"FeatureCollection\",\"features\":[{\"type\":\"Feature\",\"properties\":{},\"geometry\":{\"type\":\"Polygon\",\"coordinates\":[[";
        pTxCharacteristic->setValue((uint8_t*)p1.c_str(), p1.length());
        pTxCharacteristic->notify();
        delay(20);

        String points = "";
        for(int i=0; i<4; i++) {
          points += "[" + String(polyLon[i], 7) + "," + String(polyLat[i], 7) + "],";
        }
        points += "[" + String(polyLon[0], 7) + "," + String(polyLat[0], 7) + "]";
        
        pTxCharacteristic->setValue((uint8_t*)points.c_str(), points.length());
        pTxCharacteristic->notify();
        delay(20);

        String p3 = "]]}}]}";
        pTxCharacteristic->setValue((uint8_t*)p3.c_str(), p3.length());
        pTxCharacteristic->notify();
    }
};

void setup() {
  Serial.begin(115200);
  Serial2.begin(GPSBaud, SERIAL_8N1, RXPin, TXPin);
  pinMode(LED_TRIGGER, OUTPUT);
  digitalWrite(LED_TRIGGER, LOW);

  // Cargar Memoria
  preferences.begin("geocerca", true);
  zonaCargada = preferences.isKey("init");
  if(zonaCargada){
     for(int i=0; i<polyPoints; i++){
       polyLat[i] = preferences.getDouble(("la"+String(i)).c_str(), 0);
       polyLon[i] = preferences.getDouble(("lo"+String(i)).c_str(), 0);
     }
  }
  preferences.end();

  // Configurar BLE
  BLEDevice::init("Geocerca_BLE"); // NOMBRE DEL BLUETOOTH
  BLEServer *pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());
  BLEService *pService = pServer->createService(SERVICE_UUID);
  pTxCharacteristic = pService->createCharacteristic(CHARACTERISTIC_UUID_TX, BLECharacteristic::PROPERTY_NOTIFY);
  pTxCharacteristic->addDescriptor(new BLE2902());
  BLECharacteristic *pRxCharacteristic = pService->createCharacteristic(CHARACTERISTIC_UUID_RX, BLECharacteristic::PROPERTY_WRITE);
  pRxCharacteristic->setCallbacks(new MyCallbacks());
  pService->start();
  pServer->getAdvertising()->start();
  Serial.println("BLE LISTO");
}

void loop() {
  // Reconexión automática de publicidad
  if (!deviceConnected && oldDeviceConnected) {
      delay(500); 
      BLEDevice::startAdvertising(); 
      oldDeviceConnected = deviceConnected;
  }
  if (deviceConnected && !oldDeviceConnected) {
      oldDeviceConnected = deviceConnected;
  }

  while (Serial2.available() > 0) {
    gps.encode(Serial2.read());
    if (gps.location.isUpdated()) {
      double lat = gps.location.lat();
      double lon = gps.location.lng();
      double hdop = gps.hdop.hdop();

      if (hdop > HDOP_MAXIMO || hdop == 0.0) continue;

      String st = "NO_CONFIG";
      bool dentro = false;

      if(zonaCargada) {
         int i, j = polyPoints - 1;
         for (i = 0; i < polyPoints; j = i++) {
           if (((polyLat[i] > lat) != (polyLat[j] > lat)) &&
              (lon < (polyLon[j] - polyLon[i]) * (lat - polyLat[i]) / (polyLat[j] - polyLat[i]) + polyLon[i])) {
              dentro = !dentro;
           }
         }
         if(dentro) { digitalWrite(LED_TRIGGER, LOW); st = "INSIDE"; }
         else { digitalWrite(LED_TRIGGER, HIGH); st = "ALARM"; }
      }

      // Enviar por BLE
      if (deviceConnected) {
         static unsigned long t = 0;
         if(millis() - t > 1000) {
            String json = "DATA:{\"lat\":" + String(lat, 7) + ",\"lon\":" + String(lon, 7) + ",\"status\":\"" + st + "\"}";
            pTxCharacteristic->setValue((uint8_t*)json.c_str(), json.length());
            pTxCharacteristic->notify();
            t = millis();
         }
      }
    }
  }
}
