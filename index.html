#include <WiFi.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include <TinyGPS++.h>
#include <Preferences.h>

// --- HARDWARE ---
static const int RXPin = 16; 
static const int TXPin = 17; 
static const int LED_TRIGGER = 2; 
static const uint32_t GPSBaud = 9600;

// --- AJUSTES ---
const double HDOP_STRICT = 3.0; 
const int polyPoints = 4;
double polyLat[polyPoints]; 
double polyLon[polyPoints]; 

TinyGPSPlus gps;
Preferences preferences; 
WebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

bool clientConnected = false;
bool modoConfig = false;
bool zonaCargada = false;

// --- INTERFAZ WEB (HTML/JS/CSS) GUARDADA EN EL CHIP ---
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geocerca WiFi Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: row; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; background: #2c3e50; overflow: hidden; }
        
        #sidebar { width: 300px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto; }
        h2 { text-align: center; margin: 0 0 15px 0; font-size: 18px; color: #ecf0f1; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .status-box { padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; margin-top: 5px; font-size: 12px; }
        #lbl-connection { background-color: #f39c12; color: white; } 
        
        .data-panel { background-color: #34495e; padding: 8px; border-radius: 4px; margin-top: 10px; text-align: center; border: 1px solid #4a6278; }
        .coord-text { font-family: monospace; font-size: 13px; color: #3498db; font-weight: bold; display: block; }
        
        button { padding: 12px; margin-top: 8px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-blue { background-color: #2980b9; } .btn-purple { background-color: #8e44ad; } 
        .btn-orange { background-color: #d35400; } .btn-red { background-color: #c0392b; }
        
        #map { flex-grow: 1; height: 100%; }
        
        /* MODAL WIFI */
        #wifi-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .wifi-list-box { background: #2c3e50; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #444; }
        .wifi-header { padding: 15px; background: #34495e; color: white; text-align: center; font-weight: bold; }
        .wifi-content { overflow-y: auto; flex-grow: 1; padding: 10px; }
        .wifi-item { padding: 12px; border-bottom: 1px solid #444; color: white; cursor: pointer; display: flex; justify-content: space-between; }
        .wifi-item:hover { background: #2980b9; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>CERCA VIRTUAL</h2>
        <div id="lbl-connection" class="status-box">CONECTADO A ESP32</div>
        
        <div class="data-panel">
            <span id="val-lat" class="coord-text">Lat: 0.00000</span>
            <span id="val-lon" class="coord-text">Lon: 0.00000</span>
        </div>

        <button class="btn-blue" onclick="scanNetworks()">üîç BUSCAR REDES WIFI</button>
        <button class="btn-purple" onclick="configManual()">‚öô MANUAL</button>
        <button class="btn-orange" onclick="startDrawing()">‚úè DIBUJAR</button>
        <button class="btn-red" onclick="factoryReset()">üóë BORRAR</button>
    </div>

    <div id="map"></div>

    <!-- MODAL LISTA WIFI -->
    <div id="wifi-modal">
        <div class="wifi-list-box">
            <div class="wifi-header">SELECCIONA TU RED</div>
            <div id="wifi-container" class="wifi-content">Escaneando...</div>
            <div class="wifi-footer" style="padding:10px; text-align:center;">
                <button class="btn-red" onclick="document.getElementById('wifi-modal').style.display='none'">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        let socket, map, fenceLayer, markersLayer, myMarker;
        let isDrawing = false, startLatLng = null, tempRect = null;

        window.onload = () => {
            map = L.map('map', {zoomControl: false}).setView([4.570, -75.641], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
            fenceLayer = L.layerGroup().addTo(map);
            
            // Eventos Dibujo
            map.on('mousedown', onDragStart); map.on('mousemove', onDragMove); map.on('mouseup', onDragEnd);
            map.on('touchstart', onDragStart); map.on('touchmove', onDragMove); map.on('touchend', onDragEnd);

            connectSocket();
        };

        function connectSocket() {
            socket = new WebSocket('ws://' + window.location.hostname + ':81');
            socket.onopen = () => socket.send("GEOJSON");
            socket.onmessage = (event) => processMsg(event.data);
        }

        function processMsg(msg) {
            if (msg.startsWith("DATA:")) updateUI(JSON.parse(msg.replace("DATA:", "")));
            else if (msg.startsWith("GEOJSON:")) drawFence(msg.replace("GEOJSON:", ""));
            else if (msg.startsWith("NETWORKS:")) showWifiList(msg.replace("NETWORKS:", ""));
        }

        // --- WIFI MANAGER ---
        function scanNetworks() {
            document.getElementById("wifi-modal").style.display = "flex";
            document.getElementById("wifi-container").innerHTML = "Escaneando...";
            socket.send("SCAN");
        }

        function showWifiList(jsonStr) {
            const list = JSON.parse(jsonStr);
            const container = document.getElementById("wifi-container");
            container.innerHTML = "";
            if(list.length === 0) container.innerHTML = "Sin redes.";
            
            list.forEach(net => {
                const div = document.createElement("div");
                div.className = "wifi-item";
                div.innerHTML = `<span>${net.ssid}</span> <small>${net.rssi} dB</small>`;
                div.onclick = () => {
                    const pass = prompt("Clave para " + net.ssid + ":");
                    if(pass !== null) socket.send("CONNECT:" + net.ssid + "," + pass);
                };
                container.appendChild(div);
            });
        }

        // --- UI ---
        function updateUI(data) {
            document.getElementById('val-lat').innerText = "Lat: " + data.lat.toFixed(5);
            document.getElementById('val-lon').innerText = "Lon: " + data.lon.toFixed(5);
            if(!myMarker) myMarker = L.marker([data.lat, data.lon]).addTo(map);
            else myMarker.setLatLng([data.lat, data.lon]);
        }

        function drawFence(jsonStr) {
            try {
                const data = JSON.parse(jsonStr);
                const coords = data.features[0].geometry.coordinates[0];
                const latlngs = coords.map(p => [p[1], p[0]]);
                fenceLayer.clearLayers();
                L.polygon(latlngs, {color:'blue'}).addTo(fenceLayer);
            } catch(e){}
        }

        // --- DIBUJO ---
        function onDragStart(e) {
            if (!isDrawing) return;
            startLatLng = e.latlng;
            tempRect = L.rectangle([startLatLng, startLatLng], {color:"red"}).addTo(map);
        }
        function onDragMove(e) {
            if (!isDrawing || !startLatLng) return;
            tempRect.setBounds([startLatLng, e.latlng]);
        }
        function onDragEnd(e) {
            if (!isDrawing || !startLatLng) return;
            const b = tempRect.getBounds();
            const ne = b.getNorthEast(); const sw = b.getSouthWest();
            const str = ne.lat.toFixed(6) + "," + sw.lng.toFixed(6) + "," + ne.lat.toFixed(6) + "," + ne.lng.toFixed(6) + "," + sw.lat.toFixed(6) + "," + ne.lng.toFixed(6) + "," + sw.lat.toFixed(6) + "," + sw.lng.toFixed(6);
            if(confirm("¬øGuardar zona?")) socket.send("SAVE:" + str);
            map.removeLayer(tempRect); isDrawing = false;
        }

        function startDrawing() { isDrawing = true; alert("Arrastra en el mapa"); }
        function configManual() { const v = prompt("Coords:"); if(v) socket.send("SAVE:" + v); }
        function factoryReset() { if(confirm("Borrar?")) socket.send("RESET"); }
    </script>
</body>
</html>
)rawliteral";

// --- FUNCIONES ESP32 ---

void handleRoot() { server.send(200, "text/html", index_html); }

void escanearRedes() {
  int n = WiFi.scanNetworks();
  String json = "NETWORKS:[";
  for (int i = 0; i < n; ++i) {
    if(i>0) json += ",";
    json += "{\"ssid\":\"" + WiFi.SSID(i) + "\",\"rssi\":" + String(WiFi.RSSI(i)) + "}";
  }
  json += "]";
  webSocket.broadcastTXT(json);
  WiFi.scanDelete();
}

void guardarWiFi(String datos) {
  String payload = datos.substring(8); // Quitar "CONNECT:"
  int comma = payload.indexOf(',');
  if(comma > 0) {
      String s = payload.substring(0, comma);
      String p = payload.substring(comma + 1);
      
      preferences.begin("wifi_conf", false);
      preferences.putString("ssid", s);
      preferences.putString("pass", p);
      preferences.end();
      
      webSocket.broadcastTXT("MSG:Guardado. Reiniciando...");
      delay(1000);
      ESP.restart();
  }
}

void guardarZona(String d) {
    double tLat[4], tLon[4];
    int idx = 0, next = 0;
    for (int i = 0; i < 8; i++) {
      next = d.indexOf(',', idx);
      String s = (next == -1) ? d.substring(idx) : d.substring(idx, next);
      s.trim();
      double v = s.toDouble();
      if (v == 0.0 && s != "0") return;
      if (i % 2 == 0) tLat[i/2] = v; else tLon[i/2] = v;
      if (next == -1 && i < 7) return;
      idx = next + 1;
    }
    preferences.begin("geocerca", false);
    for(int i=0; i<4; i++) {
      polyLat[i] = tLat[i]; polyLon[i] = tLon[i];
      preferences.putDouble(("la"+String(i)).c_str(), tLat[i]);
      preferences.putDouble(("lo"+String(i)).c_str(), tLon[i]);
    }
    preferences.putBool("init", true);
    preferences.end();
    zonaCargada = true;
    sendGeoJSON();
}

void sendGeoJSON() {
    if(!zonaCargada) return;
    String json = "GEOJSON:{\"type\":\"FeatureCollection\",\"features\":[{\"type\":\"Feature\",\"properties\":{},\"geometry\":{\"type\":\"Polygon\",\"coordinates\":[[";
    for(int i=0; i<4; i++) json += "[" + String(polyLon[i], 7) + "," + String(polyLat[i], 7) + "],";
    json += "[" + String(polyLon[0], 7) + "," + String(polyLat[0], 7) + "]";
    json += "]]}}]}";
    webSocket.broadcastTXT(json);
}

void webSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
    if(type == WStype_CONNECTED) {
        clientConnected = true;
        if(zonaCargada) sendGeoJSON();
    }
    else if(type == WStype_TEXT) {
        String cmd = (char*)payload;
        if (cmd == "SCAN") escanearRedes();
        else if (cmd.startsWith("CONNECT:")) guardarWiFi(cmd);
        else if (cmd.startsWith("SAVE:")) guardarZona(cmd.substring(5));
        else if (cmd == "GEOJSON") sendGeoJSON();
        else if (cmd == "RESET") {
           preferences.begin("geocerca", false); preferences.clear(); preferences.end();
           zonaCargada = false; digitalWrite(LED_TRIGGER, LOW);
           sendGeoJSON(); // Limpiar mapa
        }
    }
}

void setup() {
  Serial.begin(115200);
  Serial2.begin(GPSBaud, SERIAL_8N1, RXPin, TXPin);
  pinMode(LED_TRIGGER, OUTPUT);
  digitalWrite(LED_TRIGGER, LOW);
  
  // GPS OPTIMIZADO
  Serial2.println("$PCAS04,5*1C"); delay(250);
  Serial2.println("$PCAS11,3*1E"); delay(250);

  preferences.begin("geocerca", true);
  zonaCargada = preferences.isKey("init");
  if(zonaCargada){
     for(int i=0; i<polyPoints; i++){
       polyLat[i] = preferences.getDouble(("la"+String(i)).c_str(), 0);
       polyLon[i] = preferences.getDouble(("lo"+String(i)).c_str(), 0);
     }
  }
  preferences.end();

  // 1. INTENTAR CONECTAR A WIFI GUARDADO
  preferences.begin("wifi_conf", true);
  String s = preferences.getString("ssid", "");
  String p = preferences.getString("pass", "");
  preferences.end();

  WiFi.mode(WIFI_AP_STA); // Modo H√≠brido (Hotspot + Cliente)
  
  // Siempre crear Hotspot para configuraci√≥n
  WiFi.softAP("GEOCERCA_SETUP", "12345678");
  Serial.println("Hotspot: GEOCERCA_SETUP (192.168.4.1)");

  // Si hay credenciales, conectar a internet
  if(s.length() > 0) {
      WiFi.begin(s.c_str(), p.c_str());
      Serial.print("Conectando a: "); Serial.println(s);
  }

  server.on("/", handleRoot);
  server.begin();
  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  webSocket.loop();
  server.handleClient();

  while (Serial2.available() > 0) {
    gps.encode(Serial2.read());
    if (gps.location.isUpdated()) {
      double lat = gps.location.lat();
      double lon = gps.location.lng();
      double hdop = gps.hdop.hdop();

      if (hdop > HDOP_STRICT || hdop == 0.0) continue;

      String st = "NO_CONFIG";
      bool dentro = false;

      if(zonaCargada) {
         int i, j = polyPoints - 1;
         for (i = 0; i < polyPoints; j = i++) {
           if (((polyLat[i] > lat) != (polyLat[j] > lat)) &&
              (lon < (polyLon[j] - polyLon[i]) * (lat - polyLat[i]) / (polyLat[j] - polyLat[i]) + polyLon[i])) {
              dentro = !dentro;
           }
         }
         if(dentro) { digitalWrite(LED_TRIGGER, LOW); st = "INSIDE"; }
         else { digitalWrite(LED_TRIGGER, HIGH); st = "ALARM"; }
      } else { digitalWrite(LED_TRIGGER, LOW); }

      if (clientConnected) {
         static unsigned long t = 0;
         if(millis() - t > 500) {
            String json = "DATA:{\"lat\":" + String(lat, 7) + ",\"lon\":" + String(lon, 7) + ",\"status\":\"" + st + "\"}";
            webSocket.broadcastTXT(json);
            t = millis();
         }
      }
    }
  }
}
