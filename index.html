<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Geocerca ESP32 - PC Master</title>
    
    <!-- Librer√≠a Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        
        /* --- PANEL IZQUIERDO --- */
        #sidebar {
            width: 300px; background-color: #2c3e50; color: white;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 1000;
            flex-shrink: 0; 
        }

        h2 { text-align: center; margin: 0 0 20px 0; font-size: 20px; }
        
        .label-title { font-size: 11px; color: #bdc3c7; margin-top: 15px; font-weight: bold; }
        
        /* Etiquetas de Estado */
        .status-box {
            padding: 8px; border-radius: 4px; text-align: center; font-weight: bold; margin-top: 5px; font-size: 13px;
        }
        #lbl-connection { background-color: #c0392b; margin-bottom: 10px; } /* Rojo */
        #lbl-zone-status { background-color: #95a5a6; color: white; }

        /* Panel de Datos */
        .data-panel {
            background-color: #34495e; padding: 10px; border-radius: 4px;
            margin-top: 5px; border: 1px solid #465c71; text-align: center;
        }
        .coord-text { font-family: monospace; font-size: 15px; color: #3498db; font-weight: bold; display: block; }

        /* Botones */
        button {
            padding: 12px; margin-top: 8px; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 13px;
        }
        button:active { transform: scale(0.98); }

        .btn-green { background-color: #27ae60; color: white; }
        .btn-purple { background-color: #8e44ad; color: white; }
        .btn-orange { background-color: #d35400; color: white; }
        .btn-red { background-color: #c0392b; color: white; }
        .btn-gray { background-color: #7f8c8d; color: white; }

        #lbl-instruction {
            color: #f1c40f; text-align: center; font-style: italic; min-height: 20px; margin-top: 10px; font-size: 12px;
        }

        /* --- MAPA --- */
        #map { flex-grow: 1; height: 100%; cursor: crosshair; }

        /* Overlay de Carga */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-box {
            background: white; padding: 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; border: 1px solid #ddd;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- SIDEBAR DE CONTROL -->
    <div id="sidebar">
        <h2>CERCA VIRTUAL</h2>

        <div style="width: 100%;">
            <div id="lbl-connection" class="status-box">DESCONECTADO</div>
        </div>
        
        <div style="width: 100%;">
            <div class="label-title">PUERTO COM:</div>
            <button id="btn-connect" class="btn-green" onclick="toggleConnection()">üîå CONECTAR</button>
        </div>

        <div style="width: 100%;">
            <div class="label-title">ESTADO DE ZONA:</div>
            <div id="lbl-zone-status" class="status-box">---</div>
        </div>

        <div class="data-panel" style="width: 100%;">
            <div style="font-size: 10px; color: #ecf0f1; margin-bottom:5px;">POSICI√ìN ACTUAL</div>
            <span id="val-lat" class="coord-text">Lat: 0.000000</span>
            <span id="val-lon" class="coord-text">Lon: 0.000000</span>
        </div>

        <div id="lbl-instruction" style="width: 100%;"></div>

        <div style="width: 100%; margin-top: auto;">
            <button class="btn-purple" onclick="configManual()">‚öô COORDENADAS MANUALES</button>
            <button id="btn-draw" class="btn-orange" onclick="toggleDrawMode()">‚úè DIBUJAR CERCA (Arrastrar)</button>
            <button class="btn-red" onclick="factoryReset()">‚ö† BORRAR COORDENADAS</button>
        </div>
    </div>

    <!-- MAPA -->
    <div id="map"></div>

    <!-- OVERLAY DE CARGA -->
    <div id="loading-overlay">
        <div class="loader-box">
            <h3 id="load-title" style="margin:0; color:#333;">Cargando...</h3>
            <div class="spinner"></div>
            <div id="load-desc" style="color:#666;">Espere respuesta...</div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let map, polygonLayer, markersLayer, myMarker;
        let port, reader, writer;
        let isConnected = false;
        let isLoading = false;
        
        // Variables Dibujo
        let isDrawing = false;
        let startPoint = null;
        let tempRect = null;

        // --- INICIALIZAR ---
        window.onload = function() {
            // Mapa centrado en Colombia
            map = L.map('map', { zoomControl: false }).setView([4.570868, -75.641], 16);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            polygonLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            // Eventos para arrastrar rect√°ngulo (Mouse)
            map.on('mousedown', onDragStart);
            map.on('mousemove', onDragMove);
            map.on('mouseup', onDragEnd);
            
            // Evitar men√∫ contextual
            document.getElementById('map').oncontextmenu = function(e) { e.preventDefault(); };
        };

        // --- L√ìGICA SERIAL (USB NATIVO PARA PC) ---
        async function toggleConnection() {
            if (!isConnected) {
                // Verificamos soporte nativo del navegador (Chrome/Edge en PC)
                if ("serial" in navigator) {
                    try {
                        showLoading("üîå Conectando...", "Seleccione el puerto del ESP32");
                        
                        // Pedir puerto nativamente
                        port = await navigator.serial.requestPort();
                        await port.open({ baudRate: 115200 });
                        
                        // Configurar Streams de lectura/escritura
                        const textDecoder = new TextDecoderStream();
                        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                        reader = textDecoder.readable.getReader();

                        const textEncoder = new TextEncoderStream();
                        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                        writer = textEncoder.writable.getWriter();

                        isConnected = true;
                        updateUIConn(true);
                        
                        // Enviar comando para despertar y pedir mapa
                        setTimeout(() => sendCommand("GEOJSON"), 1000);
                        
                        // Iniciar bucle de lectura
                        readLoop();
                    } catch (err) {
                        hideLoading();
                        console.error(err);
                        // No mostrar alerta si el usuario cancel√≥ la selecci√≥n
                        if(!err.message.includes("No port selected")) {
                            alert("Error de conexi√≥n: " + err.message);
                        }
                    }
                } else {
                    alert("Tu navegador no soporta Web Serial. Por favor usa Google Chrome o Microsoft Edge.");
                    hideLoading();
                }
            } else {
                // Para desconectar limpiamente, recargamos la p√°gina
                location.reload(); 
            }
        }

        async function readLoop() {
            let buffer = "";
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) {
                        // El lector se ha cerrado
                        break;
                    }
                    buffer += value;
                    // Procesar l√≠neas completas
                    let lines = buffer.split('\n');
                    buffer = lines.pop(); // Guardar el fragmento incompleto para la siguiente vuelta

                    for (const line of lines) {
                        processLine(line.trim());
                    }
                } catch (e) {
                    console.error("Error de lectura:", e);
                    break;
                }
            }
        }

        async function sendCommand(cmd) {
            if (writer) {
                await writer.write(cmd + "\n");
                console.log("TX:", cmd);
            }
        }

        // --- PROCESAMIENTO DE DATOS ---
        function processLine(line) {
            console.log("RX:", line);

            // --- L√ìGICA DE HANDSHAKE (QUITAR CARGA) ---
            if (isLoading && (line.startsWith("DATA:") || line.startsWith("GEOJSON:") || line.startsWith("SYSTEM:"))) {
                const title = document.getElementById('load-title').innerText;
                
                // Si estamos conectando, cualquier dato sirve para confirmar
                if (title.includes("Conectando")) {
                    hideLoading();
                }
                // Si estamos actualizando zona, SOLO el mapa quita la carga
                else if (title.includes("Actualizando") && (line.startsWith("GEOJSON:") || line.startsWith("JSON_START:"))) {
                    hideLoading();
                }
            }

            // 1. Datos en Tiempo Real
            if (line.startsWith("DATA:")) {
                try {
                    const data = JSON.parse(line.replace("DATA:", ""));
                    updateDashboard(data);
                } catch(e){}
            } 
            // 2. Mapa GeoJSON
            else if (line.startsWith("GEOJSON:") || line.startsWith("JSON_START:")) {
                try {
                    let jsonStr = line.replace("GEOJSON:", "").replace("JSON_START:", "");
                    drawGeoJSON(jsonStr);
                } catch(e){}
            }
        }

        function updateDashboard(data) {
            document.getElementById('val-lat').innerText = `Lat: ${data.lat.toFixed(6)}`;
            document.getElementById('val-lon').innerText = `Lon: ${data.lon.toFixed(6)}`;

            const lbl = document.getElementById('lbl-zone-status');
            const states = {
                "INSIDE": { txt: "DENTRO (SEGURO)", col: "#27ae60" },
                "ALARM": { txt: "!!! ALARMA !!!", col: "#c0392b" },
                "BAD_SIGNAL": { txt: "MALA SE√ëAL", col: "#f39c12" },
                "NO_CONFIG": { txt: "SIN CONFIGURAR", col: "#3498db" }
            };
            const st = states[data.status] || { txt: "DESCONOCIDO", col: "gray" };
            lbl.innerText = st.txt;
            lbl.style.backgroundColor = st.col;

            // Marcador "Yo" (Rojo)
            if (!myMarker) {
                myMarker = L.circleMarker([data.lat, data.lon], {
                    radius: 8, fillColor: "#d32f2f", color: "#fff", weight: 2, fillOpacity: 1
                }).addTo(map).bindPopup("Yo");
            } else {
                myMarker.setLatLng([data.lat, data.lon]);
            }
        }

        function drawGeoJSON(jsonStr) {
            // Seguridad: Si llega el mapa, quitamos carga
            hideLoading();
            try {
                const data = JSON.parse(jsonStr);
                const coords = data.features[0].geometry.coordinates[0];
                const latlngs = coords.map(p => [p[1], p[0]]); // Leaflet es [Lat, Lon]

                polygonLayer.clearLayers();
                markersLayer.clearLayers();

                // Path Azul (Borde)
                const poly = L.polygon(latlngs, {
                    color: 'blue', weight: 4, fillOpacity: 0.1
                }).addTo(polygonLayer);

                // Marcadores esquinas (Azules limpios)
                latlngs.pop(); // Quitar el ultimo repetido
                latlngs.forEach((p, i) => {
                    L.circleMarker(p, { 
                        radius: 6, fillColor: "#2980b9", color: "#fff", weight: 2, fillOpacity: 1 
                    }).addTo(markersLayer);
                });

                if(latlngs.length > 0) map.fitBounds(poly.getBounds());
            } catch(e) { console.error(e); }
        }

        // --- DIBUJO (ARRASTRAR) ---
        function toggleDrawMode() {
            if (!isConnected) return alert("Conecta el ESP32 primero");
            isDrawing = !isDrawing;
            const btn = document.getElementById('btn-draw');
            const info = document.getElementById('lbl-instruction');

            if (isDrawing) {
                btn.innerText = "‚ùå CANCELAR";
                btn.style.backgroundColor = "gray";
                info.innerText = "TOCA Y ARRASTRA EN EL MAPA";
                map.dragging.disable(); // Bloquear movimiento del mapa
            } else {
                btn.innerText = "‚úè DIBUJAR CERCA (Arrastrar)";
                btn.style.backgroundColor = "#d35400";
                info.innerText = "";
                map.dragging.enable(); // Reactivar movimiento
                if(tempRect) { map.removeLayer(tempRect); tempRect = null; }
            }
        }

        function onDragStart(e) {
            if (!isDrawing) return;
            startPoint = e.latlng;
            // Rect√°ngulo Rojo Temporal (Solo borde visual)
            tempRect = L.rectangle([startPoint, startPoint], {color: "red", weight: 2, fill: false}).addTo(map);
        }

        function onDragMove(e) {
            if (!isDrawing || !startPoint || !tempRect) return;
            tempRect.setBounds([startPoint, e.latlng]);
        }

        function onDragEnd(e) {
            if (!isDrawing || !startPoint) return;
            
            const bounds = tempRect.getBounds();
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            // 4 Puntos: ArribaIzq, ArribaDer, AbajoDer, AbajoIzq
            const p1 = [ne.lat, sw.lng];
            const p2 = [ne.lat, ne.lng];
            const p3 = [sw.lat, ne.lng];
            const p4 = [sw.lat, sw.lng];
            
            const coordsStr = `${p1[0]},${p1[1]},${p2[0]},${p2[1]},${p3[0]},${p3[1]},${p4[0]},${p4[1]}`;
            
            // Borrar dibujo rojo inmediatamente para limpieza visual
            map.removeLayer(tempRect);
            tempRect = null;
            startPoint = null;

            if(confirm("¬øEstablecer esta zona?")) {
                sendCommand("CONFIG");
                setTimeout(() => {
                    sendCommand(coordsStr);
                    showLoading("üì° Actualizando Zona...", "Guardando en el ESP32");
                    
                    // Esperar mapa. NO hay timer de ocultar, se oculta al llegar GEOJSON.
                    setTimeout(() => sendCommand("GEOJSON"), 3000);
                }, 500);
            }
            
            toggleDrawMode(); // Salir del modo dibujo
        }

        // --- UTILS UI ---
        function updateUIConn(status) {
            const lbl = document.getElementById('lbl-connection');
            const btn = document.getElementById('btn-connect');
            if (status) {
                lbl.innerText = "CONECTADO";
                lbl.style.backgroundColor = "#27ae60";
                btn.innerText = "DESCONECTAR";
                btn.className = "btn-red";
            }
        }

        function showLoading(title, desc) {
            isLoading = true;
            document.getElementById('load-title').innerText = title;
            document.getElementById('load-desc').innerText = desc;
            document.getElementById('loading-overlay').style.display = "flex"; 
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-overlay').style.display = "none";
        }

        function configManual() {
            if (!isConnected) return alert("Conecta primero");
            const val = prompt("Ingresa: Lat1,Lon1,Lat2,Lon2...\nEj: 4.57,-75.64...");
            if (val) {
                sendCommand("CONFIG");
                setTimeout(() => {
                    sendCommand(val);
                    showLoading("üì° Actualizando...", "Enviando datos");
                    setTimeout(() => sendCommand("GEOJSON"), 3000);
                }, 500);
            }
        }

        function factoryReset() {
            if (!isConnected) return alert("Conecta primero");
            if(confirm("¬øBorrar configuraci√≥n?")) {
                sendCommand("RESET");
                polygonLayer.clearLayers();
                markersLayer.clearLayers();
            }
        }

    </script>
</body>
</html>
